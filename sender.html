<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î (‡∏ú‡∏π‡πâ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto; margin:18px}
    .card{max-width:520px;margin:auto;padding:16px;border:1px solid #ddd;border-radius:14px}
    label{display:block;margin:10px 0 6px;color:#444}
    select,input,button{width:100%;padding:12px;border-radius:10px;border:1px solid #ccc;font-size:16px}
    button{border:none;background:#0ea5e9;color:#fff;font-weight:800;margin-top:12px}
    button:disabled{opacity:.6}
    .muted{color:#666;font-size:13px;margin-top:10px}
    .ok{color:#16a34a;font-weight:800}
    .err{color:#dc2626;font-weight:800}
    code{background:#f3f4f6;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
<div class="card">
  <h2 style="margin:0 0 6px;">‡∏™‡πà‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</h2>
  <div class="muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å <b>‡∏™‡∏≤‡∏¢</b> ‡πÅ‡∏•‡∏∞ <b>‡∏Ñ‡∏±‡∏ô‡∏£‡∏ñ</b> ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡∏™‡πà‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î ‚Üí ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheet</div>

  <label>‡∏™‡∏≤‡∏¢‡∏£‡∏ñ</label>
  <select id="route">
    <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢ --</option>
    <option value="‡∏™‡∏≤‡∏¢ 1">‡∏™‡∏≤‡∏¢ 1</option>
    <option value="‡∏™‡∏≤‡∏¢ 2">‡∏™‡∏≤‡∏¢ 2</option>
  </select>

  <label>‡∏Ñ‡∏±‡∏ô‡∏£‡∏ñ (vehicleId)</label>
  <input id="vehicleId" placeholder="‡πÄ‡∏ä‡πà‡∏ô S1-1, S1-2, S2-1, S2-2" />

  <button id="btn">üìç ‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á</button>

  <div id="status" class="muted"></div>
  <div id="preview" class="muted"></div>

  <hr style="border:none;border-top:1px solid #eee;margin:14px 0">
  <div class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô <b>HTTPS</b> (‡πÄ‡∏ä‡πà‡∏ô GitHub Pages) ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏Ç‡∏≠ GPS ‡πÑ‡∏î‡πâ</div>
</div>

<script>
  // ‚úÖ ‡πÉ‡∏™‡πà Apps Script Web App URL (/exec)
  const API_URL = "https://script.google.com/macros/s/AKfycbzph53toZW_Neld33MlVjCle9aTGpjABt4ejlRM4-WfvFH_9OeKIk3M6J4A3Z0fkgPHHw/execHERE";

  const routeEl = document.getElementById("route");
  const vehicleEl = document.getElementById("vehicleId");
  const btn = document.getElementById("btn");
  const statusEl = document.getElementById("status");
  const previewEl = document.getElementById("preview");

  function setStatus(msg, type="muted"){
    statusEl.className = type === "ok" ? "ok" : type === "err" ? "err" : "muted";
    statusEl.textContent = msg;
  }

  // auto-fill ‡∏à‡∏≤‡∏Å query: ?route=‡∏™‡∏≤‡∏¢%201&vehicleId=S1-1
  const qs = new URLSearchParams(location.search);
  const qRoute = qs.get("route");
  const qVeh = qs.get("vehicleId");
  if (qRoute) routeEl.value = qRoute;
  if (qVeh) vehicleEl.value = qVeh;

  function getLocation(){
    return new Promise((resolve, reject) => {
      if(!navigator.geolocation) return reject(new Error("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS"));
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true, timeout: 15000, maximumAge: 0
      });
    });
  }

  async function post(payload){
    const res = await fetch(API_URL, {
      method: "POST",
      headers: {"Content-Type":"text/plain;charset=utf-8"},
      body: JSON.stringify(payload)
    });
    return await res.json();
  }

  btn.addEventListener("click", async () => {
    const route = routeEl.value.trim();
    const vehicleId = vehicleEl.value.trim();

    if(!route) return setStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏£‡∏ñ", "err");
    if(!vehicleId) return setStatus("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å vehicleId", "err");

    btn.disabled = true;
    previewEl.textContent = "";
    setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏≤‡∏Å‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‚Ä¶");

    try{
      const pos = await getLocation();
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      previewEl.innerHTML = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: <code>${lat.toFixed(6)}, ${lng.toFixed(6)}</code>`;

      setStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheet‚Ä¶");
      const out = await post({
        route, vehicleId, lat, lng,
        userAgent: navigator.userAgent
      });

      if(out.ok) setStatus("‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úÖ", "ok");
      else setStatus("‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + (out.error || "unknown"), "err");

    }catch(e){
      setStatus("‡∏Ç‡∏≠‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ/‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò: " + (e.message || e), "err");
    }finally{
      btn.disabled = false;
    }
  });
</script>
</body>
</html>
